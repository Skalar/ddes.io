<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>Event upcasters | DDES</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://ddes.io/docs/upcasters.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://ddes.io/docs/upcasters.html">
    
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <meta name="generator" content="Hexo 3.7.1">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  <link rel="stylesheet" href="/css/navy.css">
  <!-- endbuild -->
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="DDES">
  <!-- Open Graph -->
  
  <!-- Google Analytics -->
  
</head>

<body>
  <div id="container">
    <div>
<header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a href="/" id="logo">DDES</a>
    </h1>
    <nav id="main-nav">
      <a href="/docs/" class="main-nav-link">Docs</a><a href="/api.html" class="main-nav-link">API</a><a href="https://github.com/skalar/ddes/releases" class="main-nav-link">Releases</a>
    </nav>
    <div>
      <a href="https://github.com/skalar/ddes" class="main-nav-link"><i class="fa fa-github-alt"></i></a>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>
</div>
    <div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <article class="article-container" itemscope="" itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <header class="article-header">
                <h1 class="article-title" itemprop="name">Event upcasters</h1>
                <a href="https://github.com/Skalar/ddes.io/edit/master/source/docs/upcasters.md" class="article-edit-link" title="Improve this doc"><i class="fa fa-pencil"></i></a>
              </header>
              <div class="article-content" itemprop="articleBody">
                <p>Despite thoughtful design of your event types, they sometimes need to change to accomodate your evolving system. Event upcasters allow you to do this without transforming the store or adding compatibility handling to your code.</p>
<p>Upcasters are applied when reading events from the store, before they reach your code.</p>
<p>Upcasting an event, bumps its version number, and you are required to specify the most recent version when committing the event in question. If event version is not specified when committing, it is implicitly 1.</p>
<h2 id="Example-scenario" class="article-heading"><a href="#Example-scenario" class="headerlink" title="Example scenario"></a>Example scenario<a class="article-anchor" href="#Example-scenario" aria-hidden="true"></a></h2><p>The User Created event has firstName and lastName properties, but realizing that the world doesnâ€™t work that way, you want to merge those properties into a single name property.</p>
<h3 id="Before-change" class="article-heading"><a href="#Before-change" class="headerlink" title="Before change"></a>Before change<a class="article-anchor" href="#Before-change" aria-hidden="true"></a></h3><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> User <span class="keyword">extends</span> Aggregate &#123;</span><br><span class="line">  <span class="keyword">static</span> stateReducer(state: <span class="built_in">any</span>, event: EventWithMetadata) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (event.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'Created'</span>: &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;firstName, lastName&#125; = event.properties</span><br><span class="line">        <span class="keyword">return</span> &#123;firstName, lastName&#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(props: &#123;firstName: <span class="built_in">string</span>, lastName: <span class="built_in">string</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;firstName, lastName&#125; = props</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.commit(&#123;<span class="keyword">type</span>: <span class="string">'Created'</span>, firstName, lastName&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="After-change" class="article-heading"><a href="#After-change" class="headerlink" title="After change"></a>After change<a class="article-anchor" href="#After-change" aria-hidden="true"></a></h3><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> myUpcasters = &#123;</span><br><span class="line">  User: &#123;</span><br><span class="line">    Created:</span><br><span class="line">      <span class="number">1</span>: <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;firstName, lastName&#125; = props</span><br><span class="line">        <span class="keyword">return</span> &#123;name: <span class="string">`<span class="subst">$&#123;firstName&#125;</span> <span class="subst">$&#123;lastName&#125;</span>`</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> User <span class="keyword">extends</span> Aggregate &#123;</span><br><span class="line">  <span class="keyword">static</span> upcasters = myUpcasters</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> stateReducer(state: <span class="built_in">any</span>, event: EventWithMetadata) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (event.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'Created'</span>: &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;name&#125; = event.properties</span><br><span class="line">        <span class="keyword">return</span> &#123;firstName, lastName&#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(props: &#123;name: <span class="built_in">string</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;name&#125; = props</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.commit(&#123;<span class="keyword">type</span>: <span class="string">'Created'</span>, version: <span class="number">2</span>, name&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2018-05-24T19:54:50.853Z" itemprop="dateModified">Last updated: 2018-05-24</time>
                <a href="event_streaming.html" class="article-footer-prev" title="Event streaming"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="auto_scaling.html" class="article-footer-next" title="Auto-scaling"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
            </div>
          </div>
          <aside id="article-toc" role="navigation">
            <div id="article-toc-inner">
              <strong class="sidebar-title">Contents</strong>
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-scenario"><span class="toc-text">Example scenario</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Before-change"><span class="toc-text">Before change</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#After-change"><span class="toc-text">After change</span></a></li></ol></li></ol>
              <a href="#" id="article-toc-top">Back to Top</a>
            </div>
          </aside>
        </div>
      </article>
      <aside id="sidebar" role="navigation">
  <div class="inner">
    <strong class="sidebar-title">Getting Started</strong><a href="index.html" class="sidebar-link">Overview</a><a href="store.html" class="sidebar-link">Defining an EventStore</a><a href="aggregates.html" class="sidebar-link">Defining an aggregate class</a><a href="aggregate_instances.html" class="sidebar-link">Aggregate instances</a><a href="example_playground.html" class="sidebar-link">Example playground</a><strong class="sidebar-title">Usage</strong><a href="snapshots.html" class="sidebar-link">Aggregate snapshots</a><a href="projections.html" class="sidebar-link">Projections</a><a href="event_streaming.html" class="sidebar-link">Event streaming</a><a href="upcasters.html" class="sidebar-link current">Upcasters</a><a href="auto_scaling.html" class="sidebar-link">Auto-scaling</a><a href="cli.html" class="sidebar-link">Command-line interface</a>
  </div>
</aside>
    </div>
  </div>
</div>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/docs/" class="mobile-nav-link">Docs</a><a href="/api.html" class="mobile-nav-link">API</a><a href="https://github.com/skalar/ddes/releases" class="mobile-nav-link">Releases</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/skalar/ddes" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
      <strong class="mobile-nav-title">Getting Started</strong><a href="index.html" class="mobile-nav-link">Overview</a><a href="store.html" class="mobile-nav-link">Defining an EventStore</a><a href="aggregates.html" class="mobile-nav-link">Defining an aggregate class</a><a href="aggregate_instances.html" class="mobile-nav-link">Aggregate instances</a><a href="example_playground.html" class="mobile-nav-link">Example playground</a><strong class="mobile-nav-title">Usage</strong><a href="snapshots.html" class="mobile-nav-link">Aggregate snapshots</a><a href="projections.html" class="mobile-nav-link">Projections</a><a href="event_streaming.html" class="mobile-nav-link">Event streaming</a><a href="upcasters.html" class="mobile-nav-link current">Upcasters</a><a href="auto_scaling.html" class="mobile-nav-link">Auto-scaling</a><a href="cli.html" class="mobile-nav-link">Command-line interface</a>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="docs/upcasters.html">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- build:js build/js/main.js -->
<script src="/js/toc.js"></script>
<script src="/js/mobile_nav.js"></script>
<!-- endbuild -->


</body>
</html>